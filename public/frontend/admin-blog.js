// Admin Blog JavaScript
let blogQuill;
let blogPointsCount = 0;
let deleteBlogId = null;
let isEditMode = false;

// Initialize Quill Editor
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('blogDescriptionEditor')) {
        blogQuill = new Quill('#blogDescriptionEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': [] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'direction': 'rtl' }],
                    [{ 'align': [] }],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            }
        });
    }
});

// Generate Slug from Blog Name
function generateBlogSlug(name) {
    if (!name) return;
    const slugInput = document.getElementById('blogSlug');
    if (!slugInput) return;
    
    // Only auto-generate if slug is empty or matches the previous name's slug
    const currentSlug = slugInput.value.trim();
    if (currentSlug && !slugInput.dataset.autoGenerated) {
        return; // User has manually edited slug, don't override
    }
    
    // Generate slug from name
    let slug = name
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '') // Remove special characters
        .replace(/[\s_-]+/g, '-') // Replace spaces, underscores, and multiple hyphens with single hyphen
        .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
    
    slugInput.value = slug;
    slugInput.dataset.autoGenerated = 'true';
}

// Make generateBlogSlug globally available immediately
try {
    if (typeof window !== 'undefined') {
        window.generateBlogSlug = generateBlogSlug;
    }
} catch(e) {
    console.error('Error assigning generateBlogSlug:', e);
}

// Toggle Action Menu
function toggleActionMenu(button) {
    const dropdown = button.nextElementSibling;
    const allDropdowns = document.querySelectorAll('.admin-blog-action-dropdown');
    
    allDropdowns.forEach(d => {
        if (d !== dropdown) {
            d.classList.remove('show');
        }
    });
    
    if (dropdown.classList.contains('show')) {
        dropdown.classList.remove('show');
    } else {
        // Position dropdown outside table
        const rect = button.getBoundingClientRect();
        dropdown.style.top = (rect.bottom + 5) + 'px';
        dropdown.style.left = (rect.right - 180) + 'px';
        dropdown.classList.add('show');
    }
}

// Close action menus when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.admin-blog-action-menu')) {
        document.querySelectorAll('.admin-blog-action-dropdown').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
    }
});

// Close All Modals
function closeAllModals() {
    // Close all action dropdowns
    document.querySelectorAll('.admin-blog-action-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
    });
    
    // Close Blog Panel
    const blogPanel = document.getElementById('blogPanel');
    const blogPanelOverlay = document.getElementById('blogPanelOverlay');
    if (blogPanel && blogPanel.classList.contains('show')) {
        blogPanel.classList.remove('show');
        blogPanelOverlay.classList.remove('show');
    }
    
    // Close View Modal
    const viewModal = document.getElementById('viewBlogModal');
    if (viewModal && viewModal.classList.contains('show')) {
        viewModal.classList.remove('show');
    }
    
    // Close Delete Modal
    const deleteModal = document.getElementById('deleteBlogModal');
    if (deleteModal && deleteModal.classList.contains('show')) {
        deleteModal.classList.remove('show');
    }
    
    // Reset body overflow
    document.body.style.overflow = '';
}

// Open Blog Panel
function openBlogModal() {
    // Close all other modals first
    closeAllModals();
    
    // Wait for modal close animation
    setTimeout(() => {
        isEditMode = false;
        document.getElementById('blogModalTitle').textContent = 'Add New Blog';
        document.getElementById('blogForm').reset();
        document.getElementById('blogId').value = '';
        document.getElementById('blogImagePreview').classList.remove('show');
        document.getElementById('blogImage').required = true;
        document.getElementById('blogImageLabel').innerHTML = 'Blog Image <span class="required">*</span>';
        document.getElementById('blogImageHelp').textContent = 'Max size: 2MB, Max dimensions: 1200x800px';
        if (blogQuill) blogQuill.setContents([]);
        blogPointsCount = 0;
        const container = document.getElementById('blogPointsContainer');
        container.innerHTML = '';
        container.classList.remove('has-points');
        document.getElementById('blogPanelOverlay').classList.add('show');
        document.getElementById('blogPanel').classList.add('show');
        document.body.style.overflow = 'hidden';
    }, 300);
}

// Close Blog Panel
function closeBlogPanel() {
    const blogPanel = document.getElementById('blogPanel');
    const blogPanelOverlay = document.getElementById('blogPanelOverlay');
    
    if (blogPanel) {
        blogPanel.classList.remove('show');
    }
    if (blogPanelOverlay) {
        blogPanelOverlay.classList.remove('show');
    }
    
    document.body.style.overflow = '';
    resetBlogForm();
}

// Reset Blog Form
function resetBlogForm() {
    document.getElementById('blogForm').reset();
    document.getElementById('blogId').value = '';
    document.getElementById('blogImagePreview').classList.remove('show');
    if (blogQuill) blogQuill.setContents([]);
    blogPointsCount = 0;
    const container = document.getElementById('blogPointsContainer');
    container.innerHTML = '';
    container.classList.remove('has-points');
    container.removeAttribute('data-original-points');
    
    // Remove original values
    document.getElementById('blogName').removeAttribute('data-original-name');
    document.getElementById('blogSlug').removeAttribute('data-original-slug');
    document.getElementById('blogDescription').removeAttribute('data-original-description');
    
    // Reset slug auto-generation flag
    const slugInput = document.getElementById('blogSlug');
    if (slugInput) {
        slugInput.value = '';
        slugInput.dataset.autoGenerated = '';
    }
    
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
    });
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
}

// Add Blog Point
function addBlogPoint() {
    blogPointsCount++;
    const container = document.getElementById('blogPointsContainer');
    container.classList.add('has-points');
    const pointHtml = `
        <div class="admin-blog-point-item" data-point-index="${blogPointsCount}">
            <div class="admin-blog-point-header">
                <strong>Point ${blogPointsCount}</strong>
                <button type="button" class="admin-blog-point-remove" onclick="removeBlogPoint(${blogPointsCount})">
                    <i class="fas fa-times"></i> Remove
                </button>
            </div>
            <div class="admin-blog-form-group">
                <label class="admin-blog-form-label">Point Title</label>
                <input type="text" class="admin-blog-form-input" name="points[${blogPointsCount}][title]" placeholder="Enter point title">
            </div>
            <div class="admin-blog-form-group">
                <label class="admin-blog-form-label">Point Description</label>
                <textarea class="admin-blog-form-input admin-blog-form-textarea" name="points[${blogPointsCount}][description]" placeholder="Enter point description"></textarea>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', pointHtml);
}

// Remove Blog Point
function removeBlogPoint(index) {
    const pointItem = document.querySelector(`[data-point-index="${index}"]`);
    if (pointItem) {
        pointItem.remove();
    }
    // Hide container if no points left
    const container = document.getElementById('blogPointsContainer');
    const remainingPoints = container.querySelectorAll('.admin-blog-point-item');
    if (remainingPoints.length === 0) {
        container.classList.remove('has-points');
    }
}

// Preview Blog Image
function previewBlogImage(input) {
    const preview = document.getElementById('blogImagePreview');
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.classList.add('show');
        };
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.classList.remove('show');
    }
}

// Helper function to show toast
function showToast(type, message) {
    if (typeof window.toast === 'function') {
        window.toast(type, message);
    } else if (typeof toast === 'function') {
        toast(type, message);
    } else {
        console.error('Toast function not available');
        alert(message); // Fallback to alert
    }
}

// Save Blog
function saveBlog() {
    console.log('saveBlog called');
    const form = document.getElementById('blogForm');
    if (!form) {
        console.error('Blog form not found');
        showToast('error', 'Form not found. Please refresh the page.');
        return;
    }
    
    const formData = new FormData(form);
    
    // Client-side validation
    const blogName = document.getElementById('blogName').value.trim();
    const blogSlug = document.getElementById('blogSlug').value.trim();
    const blogImage = document.getElementById('blogImage').files[0];
    const blogId = document.getElementById('blogId').value;
    
    console.log('Form data:', { blogName, blogSlug, blogId, hasImage: !!blogImage });
    
    if (!blogName) {
        showToast('error', 'Please enter blog name');
        document.getElementById('blogName').focus();
        return;
    }
    
    if (!blogSlug) {
        showToast('error', 'Please enter blog slug');
        document.getElementById('blogSlug').focus();
        return;
    }
    
    // Get Quill content
    let description = '';
    if (blogQuill) {
        description = blogQuill.root.innerHTML.trim();
        // Check if description is empty (only contains empty tags)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = description;
        if (!tempDiv.textContent.trim()) {
            showToast('error', 'Please enter blog description');
            return;
        }
        formData.append('description', description);
    } else {
        showToast('error', 'Description editor not loaded. Please refresh the page.');
        return;
    }
    
    // Check image for new blog
    if (!blogId && !blogImage) {
        showToast('error', 'Please select a blog image');
        document.getElementById('blogImage').focus();
        return;
    }
    
    // Get points data
    const points = [];
    const pointItems = document.querySelectorAll('.admin-blog-point-item');
    pointItems.forEach(item => {
        const title = item.querySelector('input[name*="[title]"]').value.trim();
        const description = item.querySelector('textarea[name*="[description]"]').value.trim();
        if (title && description) {
            points.push({ title, description });
        }
    });
    formData.append('points', JSON.stringify(points));
    
    // Clear previous errors
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
        el.classList.remove('show');
    });
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
    
    // Remove invalid state from Quill container
    const quillContainer = document.querySelector('.admin-blog-quill-container');
    if (quillContainer) {
        quillContainer.classList.remove('is-invalid');
    }
    
    // Also remove any dynamically created error messages
    const formGroups = form.querySelectorAll('.admin-blog-form-group');
    formGroups.forEach(group => {
        const existingFeedback = group.querySelector('.invalid-feedback');
        if (existingFeedback) {
            existingFeedback.textContent = '';
            existingFeedback.style.display = 'none';
            existingFeedback.classList.remove('show');
        }
    });
    
    const url = blogId ? `/admin/blogs/${blogId}` : '/admin/blogs';
    
    // Store original values for edit mode to check changes
    let hasChanges = false;
    if (blogId) {
        // Check if values changed (basic check)
        const originalName = document.getElementById('blogName').getAttribute('data-original-name');
        const originalSlug = document.getElementById('blogSlug').getAttribute('data-original-slug');
        const originalDescription = document.getElementById('blogDescription').getAttribute('data-original-description');
        
        if (originalName && originalName !== blogName) hasChanges = true;
        if (originalSlug && originalSlug !== blogSlug) hasChanges = true;
        if (originalDescription && originalDescription !== description) hasChanges = true;
        if (blogImage) hasChanges = true;
        
        // Check points changes
        const originalPoints = document.getElementById('blogPointsContainer').getAttribute('data-original-points');
        if (originalPoints && JSON.stringify(points) !== originalPoints) hasChanges = true;
    }
    
    // Add _method for PUT request (Laravel requires POST with _method=PUT)
    if (blogId) {
        formData.append('_method', 'PUT');
    }
    
    console.log('Sending request to:', url);
    console.log('FormData entries:');
    for (let pair of formData.entries()) {
        console.log(pair[0] + ': ' + (pair[1] instanceof File ? pair[1].name : pair[1]));
    }
    
    // Disable save button to prevent double submission
    const saveBtn = document.querySelector('.admin-blog-panel-btn.save');
    if (saveBtn) {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span>Saving...</span>';
    }
    
    fetch(url, {
        method: 'POST', // Always use POST, Laravel will handle PUT via _method parameter
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: formData
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);
        
        // Get response text first to see what we're dealing with
        return response.text().then(text => {
            console.log('Response text:', text);
            try {
                const data = JSON.parse(text);
                if (!response.ok) {
                    throw new Error(data.message || 'Server error');
                }
                return data;
            } catch (e) {
                // If JSON parsing fails
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}. Response: ${text.substring(0, 200)}`);
                }
                throw new Error('Invalid JSON response: ' + text.substring(0, 200));
            }
        });
    })
    .then(data => {
        console.log('Blog save response:', data);
        
        // Re-enable save button
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<span>Save</span>';
        }
        
        if (data.success) {
            if (blogId && !hasChanges) {
                showToast('info', 'No changes were made to the blog');
            } else {
                showToast('success', data.message || (blogId ? 'Blog updated successfully!' : 'Blog created successfully!'));
            }
            closeBlogPanel();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            // Show validation errors
            if (data.errors) {
                let errorCount = 0;
                
                // Map field names to their input elements
                const fieldMap = {
                    'name': document.getElementById('blogName'),
                    'slug': document.getElementById('blogSlug'),
                    'description': document.getElementById('blogDescriptionEditor'), // Quill editor
                    'image': document.getElementById('blogImage'),
                    'points': document.getElementById('blogPointsContainer')
                };
                
                Object.keys(data.errors).forEach(key => {
                    let input = null;
                    let formGroup = null;
                    
                    // Get input element based on field name
                    if (fieldMap[key]) {
                        input = fieldMap[key];
                    } else {
                        // Try to find by name attribute
                        input = form.querySelector(`[name="${key}"]`);
                    }
                    
                    // Special handling for description (Quill editor)
                    if (key === 'description') {
                        input = document.getElementById('blogDescriptionEditor');
                        formGroup = input ? input.closest('.admin-blog-form-group') : null;
                        
                        // Add error class to Quill container
                        if (input) {
                            const quillContainer = input.closest('.admin-blog-quill-container');
                            if (quillContainer) {
                                quillContainer.classList.add('is-invalid');
                            }
                        }
                    }
                    // Special handling for image field
                    else if (key === 'image') {
                        input = document.getElementById('blogImage');
                        formGroup = input ? input.closest('.admin-blog-form-group') : null;
                    }
                    // Special handling for points
                    else if (key === 'points') {
                        input = document.getElementById('blogPointsContainer');
                        formGroup = input ? input.closest('.admin-blog-form-group') : null;
                    }
                    // Regular input fields
                    else {
                        formGroup = input ? input.closest('.admin-blog-form-group') : null;
                    }
                    
                    if (input) {
                        // Add invalid class to input
                        if (input.tagName === 'INPUT' || input.tagName === 'TEXTAREA' || input.tagName === 'SELECT') {
                            input.classList.add('is-invalid');
                        }
                        
                        // Find or create feedback element
                        let feedback = null;
                        if (formGroup) {
                            feedback = formGroup.querySelector('.invalid-feedback');
                            if (!feedback) {
                                feedback = document.createElement('div');
                                feedback.className = 'invalid-feedback';
                                formGroup.appendChild(feedback);
                            }
                        } else if (input.parentElement) {
                            feedback = input.parentElement.querySelector('.invalid-feedback');
                            if (!feedback) {
                                feedback = document.createElement('div');
                                feedback.className = 'invalid-feedback';
                                input.parentElement.appendChild(feedback);
                            }
                        }
                        
                        if (feedback) {
                            feedback.textContent = data.errors[key][0];
                            feedback.style.display = 'block';
                            feedback.style.color = '#dc3545';
                            feedback.style.fontSize = '0.875rem';
                            feedback.style.marginTop = '0.5rem';
                            feedback.style.fontWeight = '500';
                            feedback.classList.add('show');
                            errorCount++;
                        }
                    }
                });
                
                // Scroll to first error
                const firstError = form.querySelector('.is-invalid, .admin-blog-quill-container.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Focus on input if it's an input element
                    if (firstError.tagName === 'INPUT' || firstError.tagName === 'TEXTAREA') {
                        firstError.focus();
                    }
                }
                
                if (errorCount > 0) {
                    showToast('error', `Please fix ${errorCount} validation error${errorCount > 1 ? 's' : ''}`);
                } else {
                    showToast('error', 'Please fix the validation errors');
                }
            } else {
                showToast('error', data.message || 'An error occurred');
            }
        }
    })
    .catch(error => {
        console.error('Error saving blog:', error);
        
        // Re-enable save button
        if (saveBtn) {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<span>Save</span>';
        }
        
        showToast('error', 'An error occurred while saving the blog: ' + error.message);
    });
}

// View Blog
function viewBlog(id) {
    // Close all other modals first
    closeAllModals();
    
    // Wait for modal close animation to complete
    setTimeout(() => {
        fetch(`/admin/blogs/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const blog = data.blog;
                const viewBody = document.getElementById('viewBlogBody');
                
                let pointsHtml = '';
                if (blog.points && blog.points.length > 0) {
                    pointsHtml = '<ul class="admin-blog-view-points">';
                    blog.points.forEach(point => {
                        pointsHtml += `
                            <li class="admin-blog-view-point-item">
                                <div class="admin-blog-view-point-title">${point.title}</div>
                                <div class="admin-blog-view-value">${point.description}</div>
                            </li>
                        `;
                    });
                    pointsHtml += '</ul>';
                }
                
                // Get image URL - check if it exists in storage or use default
                let imageUrl = '';
                let imageHtml = '';
                if (blog.image) {
                    imageUrl = `/storage/${blog.image}`;
                    imageHtml = `<div class="admin-blog-view-field">
                        <img src="${imageUrl}" alt="${blog.name || 'Blog Image'}" class="admin-blog-view-image" onerror="this.onerror=null; this.src='/images/hero_section_img1.png';">
                    </div>`;
                } else {
                    // Use default image if no image
                    const defaultImages = ['hero_section_img1.png', 'hero_section_img2.jpg', 'hero_section_img3.jpg', 'heroimg1.jpg', 'heroimg1.png', 'heroimg3.jpg', 'hotelimg-4.png'];
                    const randomImage = defaultImages[Math.floor(Math.random() * defaultImages.length)];
                    imageUrl = `/images/${randomImage}`;
                    imageHtml = `<div class="admin-blog-view-field">
                        <img src="${imageUrl}" alt="${blog.name || 'Blog Image'}" class="admin-blog-view-image">
                    </div>`;
                }
                
                viewBody.innerHTML = `
                    ${imageHtml}
                    <div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Blog Name:</span>
                        <div class="admin-blog-view-value">${blog.name || 'N/A'}</div>
                    </div>
                    <div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Blog Slug:</span>
                        <div class="admin-blog-view-value">${blog.slug || 'N/A'}</div>
                    </div>
                    <div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Blog Description:</span>
                        <div class="admin-blog-view-value">${blog.description || 'No description available'}</div>
                    </div>
                    ${pointsHtml ? `<div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Blog Points:</span>
                        ${pointsHtml}
                    </div>` : ''}
                    <div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Status:</span>
                        <div class="admin-blog-view-value">
                            <span class="admin-blog-status-badge ${blog.is_active ? 'active' : 'inactive'}">
                                ${blog.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    <div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Created At:</span>
                        <div class="admin-blog-view-value">${new Date(blog.created_at).toLocaleString()}</div>
                    </div>
                    ${blog.updated_at ? `<div class="admin-blog-view-field">
                        <span class="admin-blog-view-label">Updated At:</span>
                        <div class="admin-blog-view-value">${new Date(blog.updated_at).toLocaleString()}</div>
                    </div>` : ''}
                `;
                
                document.getElementById('viewBlogModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                toast('error', data.message || 'Failed to load blog');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toast('error', 'An error occurred while loading the blog');
        });
    }, 300);
}

// Close View Blog Modal
function closeViewBlogModal() {
    document.getElementById('viewBlogModal').classList.remove('show');
    document.body.style.overflow = '';
}

// Edit Blog
function editBlog(id) {
    // Close all other modals first
    closeAllModals();
    
    // Wait for modal close animation
    setTimeout(() => {
        fetch(`/admin/blogs/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const blog = data.blog;
                isEditMode = true;
                document.getElementById('blogModalTitle').textContent = 'Edit Blog';
                document.getElementById('blogId').value = blog.id;
                
                const nameInput = document.getElementById('blogName');
                const slugInput = document.getElementById('blogSlug');
                const descInput = document.getElementById('blogDescription');
                
                nameInput.value = blog.name;
                slugInput.value = blog.slug;
                slugInput.dataset.autoGenerated = ''; // Allow manual editing in edit mode
                
                // Store original values for change detection
                nameInput.setAttribute('data-original-name', blog.name);
                slugInput.setAttribute('data-original-slug', blog.slug);
                descInput.setAttribute('data-original-description', blog.description || '');
                
                if (blogQuill) blogQuill.root.innerHTML = blog.description || '';
                
                // Load points
                blogPointsCount = 0;
                const container = document.getElementById('blogPointsContainer');
                container.innerHTML = '';
                container.classList.remove('has-points');
                
                if (blog.points && blog.points.length > 0) {
                    container.classList.add('has-points');
                    const originalPoints = JSON.stringify(blog.points);
                    container.setAttribute('data-original-points', originalPoints);
                    
                    blog.points.forEach(point => {
                        blogPointsCount++;
                        const pointHtml = `
                            <div class="admin-blog-point-item" data-point-index="${blogPointsCount}">
                                <div class="admin-blog-point-header">
                                    <strong>Point ${blogPointsCount}</strong>
                                    <button type="button" class="admin-blog-point-remove" onclick="removeBlogPoint(${blogPointsCount})">
                                        <i class="fas fa-times"></i> Remove
                                    </button>
                                </div>
                                <div class="admin-blog-form-group">
                                    <label class="admin-blog-form-label">Point Title</label>
                                    <input type="text" class="admin-blog-form-input" name="points[${blogPointsCount}][title]" value="${(point.title || '').replace(/"/g, '&quot;')}" placeholder="Enter point title">
                                </div>
                                <div class="admin-blog-form-group">
                                    <label class="admin-blog-form-label">Point Description</label>
                                    <textarea class="admin-blog-form-input admin-blog-form-textarea" name="points[${blogPointsCount}][description]" placeholder="Enter point description">${(point.description || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', pointHtml);
                    });
                }
                
                // Load image preview if exists
                if (blog.image) {
                    const preview = document.getElementById('blogImagePreview');
                    preview.src = `/storage/${blog.image}`;
                    preview.classList.add('show');
                }
                
                // Update image field for edit mode (optional)
                document.getElementById('blogImage').required = false;
                document.getElementById('blogImageLabel').innerHTML = 'Blog Image <small class="text-muted">(Optional - leave empty to keep current image)</small>';
                document.getElementById('blogImageHelp').textContent = 'Max size: 2MB, Max dimensions: 1200x800px. Leave empty to keep current image.';
                
                document.getElementById('blogPanelOverlay').classList.add('show');
                document.getElementById('blogPanel').classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                toast('error', data.message || 'Failed to load blog');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toast('error', 'An error occurred while loading the blog');
        });
    }, 300);
}

// Confirm Delete Blog
function confirmDeleteBlog(id, name) {
    // Close all other modals first
    closeAllModals();
    
    // Wait for modal close animation
    setTimeout(() => {
        deleteBlogId = id;
        document.getElementById('deleteBlogMessage').textContent = `Are you sure you want to delete "${name}"? This action cannot be undone.`;
        document.getElementById('deleteBlogModal').classList.add('show');
        document.body.style.overflow = 'hidden';
    }, 300);
}

// Close Delete Blog Modal
function closeDeleteBlogModal() {
    document.getElementById('deleteBlogModal').classList.remove('show');
    document.body.style.overflow = '';
    deleteBlogId = null;
}

// Delete Blog
function deleteBlog() {
    if (!deleteBlogId) return;
    
    const formData = new FormData();
    formData.append('_method', 'DELETE');
    
    fetch(`/admin/blogs/${deleteBlogId}`, {
        method: 'POST',
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            'Accept': 'application/json'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Blog delete response:', data);
        if (data.success) {
            toast('success', data.message || 'Blog deleted successfully!');
            closeDeleteBlogModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            toast('error', data.message || 'Failed to delete blog');
        }
    })
    .catch(error => {
        console.error('Error deleting blog:', error);
        toast('error', 'An error occurred while deleting the blog: ' + error.message);
    });
}

// Toggle Blog Active
function toggleBlogActive(id) {
    fetch(`/admin/blogs/${id}/toggle-active`, {
        method: 'POST',
        headers: {
            'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.message || 'Server error');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Blog toggle response:', data);
        if (data.success) {
            toast('success', data.message || 'Blog status updated successfully!');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            toast('error', data.message || 'Failed to update blog status');
        }
    })
    .catch(error => {
        console.error('Error toggling blog status:', error);
        toast('error', 'An error occurred while updating blog status: ' + error.message);
    });
}

// Change Per Page
function changePerPage(perPage) {
    const url = new URL(window.location.href);
    url.searchParams.set('per_page', perPage);
    window.location.href = url.toString();
}

// Close panels on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBlogPanel();
        closeViewBlogModal();
        closeDeleteBlogModal();
    }
});
